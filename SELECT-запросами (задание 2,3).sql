--Задание 2

--Название и продолжительность самого длительного трека
SELECT 
    название_трека, 
    длительность 
FROM треки 
ORDER BY длительность DESC 
LIMIT 1;

--Название треков, продолжительность которых не менее 3,5 минут
SELECT 
    название_трека, 
    длительность 
FROM треки 
WHERE длительность >= 210  -- 3.5 минуты = 210 секунд
ORDER BY длительность DESC;

--Названия сборников, вышедших в период с 2018 по 2020 год включительно
SELECT 
    название_сборника, 
    год_выпуска 
FROM сборник 
WHERE год_выпуска BETWEEN 2018 AND 2020
ORDER BY год_выпуска;

--Исполнители, чьё имя состоит из одного слова
SELECT 
    имя_исполнителя 
FROM исполнитель 
WHERE имя_исполнителя NOT LIKE '% %';

--Название треков, которые содержат слово «мой» или «my»
SELECT 
    название_трека 
FROM треки 
WHERE LOWER(название_трека) LIKE '%мой%' 
   OR LOWER(название_трека) LIKE '%my%';

--Задание 3

-- Добавим альбомы 2019-2020 годов, если их нет
INSERT INTO альбомы (название, год_выпуска) 
SELECT 'Новый альбом 2019', 2019
WHERE NOT EXISTS (SELECT 1 FROM альбомы WHERE год_выпуска = 2019);

INSERT INTO альбомы (название, год_выпуска) 
SELECT 'Свежий альбом 2020', 2020
WHERE NOT EXISTS (SELECT 1 FROM альбомы WHERE год_выпуска = 2020);

-- Добавим исполнителя без альбома 2020 года
INSERT INTO исполнитель (имя_исполнителя) 
SELECT 'ДДТ' 
WHERE NOT EXISTS (SELECT 1 FROM исполнитель WHERE имя_исполнителя = 'ДДТ');

-- Добавим связи для новых альбомов
INSERT INTO исполнительальбом (id_исполнителя, id_альбома)
SELECT 1, id_альбома FROM альбомы WHERE год_выпуска = 2019
ON CONFLICT DO NOTHING;

INSERT INTO исполнительальбом (id_исполнителя, id_альбома)
SELECT 2, id_альбома FROM альбомы WHERE год_выпуска = 2020
ON CONFLICT DO NOTHING;

-- Добавим треки в альбомы 2019-2020
INSERT INTO треки (название_трека, длительность, id_альбома)
SELECT 'Новая песня 2019', 240, id_альбома FROM альбомы WHERE год_выпуска = 2019
ON CONFLICT DO NOTHING;

INSERT INTO треки (название_трека, длительность, id_альбома)
SELECT 'Свежий хит 2020', 210, id_альбома FROM альбомы WHERE год_выпуска = 2020
ON CONFLICT DO NOTHING;

INSERT INTO треки (название_трека, длительность, id_альбома)
SELECT 'Еще один трек 2020', 195, id_альбома FROM альбомы WHERE год_выпуска = 2020
ON CONFLICT DO NOTHING;

-- Добавим сборники с конкретным исполнителем
INSERT INTO сборник (название_сборника, год_выпуска) 
SELECT 'Лучшие хиты Короля и Шута', 2021
WHERE NOT EXISTS (SELECT 1 FROM сборник WHERE название_сборника = 'Лучшие хиты Короля и Шута');

INSERT INTO сборник (название_сборника, год_выпуска) 
SELECT 'Король и Шут: Легенды', 2019
WHERE NOT EXISTS (SELECT 1 FROM сборник WHERE название_сборника = 'Король и Шут: Легенды');

-- Добавим связи треков со сборниками
INSERT INTO трексборник (id_трека, id_сборника)
SELECT т.id_трека, с.id_сборника 
FROM треки т, сборник с 
WHERE с.название_сборника = 'Лучшие хиты Короля и Шута' 
AND т.id_альбома IN (SELECT id_альбома FROM исполнительальбом WHERE id_исполнителя = 1)
LIMIT 2
ON CONFLICT DO NOTHING;

INSERT INTO трексборник (id_трека, id_сборника)
SELECT т.id_трека, с.id_сборника 
FROM треки т, сборник с 
WHERE с.название_сборника = 'Король и Шут: Легенды' 
AND т.id_альбома IN (SELECT id_альбома FROM исполнительальбом WHERE id_исполнителя = 1)
LIMIT 2
ON CONFLICT DO NOTHING;

-- 1. Количество исполнителей в каждом жанре
SELECT 
    ж.название_жанра as Жанр,
    COUNT(жи.id_исполнителя) as Количество_исполнителей
FROM жанры ж
LEFT JOIN жанрыисполнитель жи ON ж.id_жанра = жи.id_жанра
GROUP BY ж.id_жанра, ж.название_жанра
ORDER BY Количество_исполнителей DESC;

-- 2. Количество треков, вошедших в альбомы 2019–2020 годов
SELECT 
    COUNT(т.id_трека) as Количество_треков
FROM треки т
JOIN альбомы а ON т.id_альбома = а.id_альбома
WHERE а.год_выпуска BETWEEN 2019 AND 2020;

-- 3. Средняя продолжительность треков по каждому альбому
SELECT 
    а.название as Альбом,
    а.год_выпуска as Год,
    ROUND(AVG(т.длительность), 2) as Средняя_продолжительность,
    COUNT(т.id_трека) as Количество_треков
FROM альбомы а
JOIN треки т ON а.id_альбома = т.id_альбома
GROUP BY а.id_альбома, а.название, а.год_выпуска
ORDER BY Средняя_продолжительность DESC;

-- 4. Все исполнители, которые не выпустили альбомы в 2020 году
SELECT 
    и.имя_исполнителя as Исполнитель
FROM исполнитель и
WHERE и.id_исполнителя NOT IN (
    SELECT DISTINCT иа.id_исполнителя
    FROM исполнительальбом иа
    JOIN альбомы а ON иа.id_альбома = а.id_альбома
    WHERE а.год_выпуска = 2020
)
ORDER BY и.имя_исполнителя;

-- 5. Названия сборников, в которых присутствует конкретный исполнитель (Король и Шут)
SELECT DISTINCT
    с.название_сборника as Сборник,
    с.год_выпуска as Год_выпуска
FROM сборник с
JOIN трексборник тс ON с.id_сборника = тс.id_сборника
JOIN треки т ON тс.id_трека = т.id_трека
JOIN альбомы а ON т.id_альбома = а.id_альбома
JOIN исполнительальбом иа ON а.id_альбома = иа.id_альбома
JOIN исполнитель и ON иа.id_исполнителя = и.id_исполнителя
WHERE и.имя_исполнителя = 'Король и Шут'
ORDER BY с.год_выпуска DESC;








